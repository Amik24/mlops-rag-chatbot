import os
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_community.vectorstores import FAISS
from src.data.clean_transform import process_documents # Utilise le chemin relatif corrigé

# ATTENTION : La sauvegarde FAISS génère un dossier, non un seul fichier.
# Le chemin que vous utilisez dans CI/CD sera 'data/processed/faiss_index'
PROCESSED_DATA_PATH = "data/processed/faiss_index" 

def build_vector_store():
    # 1. Get Chunks
    chunks = process_documents()
    if not chunks:
        print("❌ Pas de données à intégrer.")
        return

    # 2. Initialize Embedding Model
    print("⏳ Génération des Embeddings (cela peut prendre un instant)...")
    embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/all-MiniLM-L6-v2")

    # 3. Create Vector Store
    vector_store = FAISS.from_documents(chunks, embeddings)

    # 4. Save to Disk
    if not os.path.exists(os.path.dirname(PROCESSED_DATA_PATH)):
        os.makedirs(os.path.dirname(PROCESSED_DATA_PATH))
    
    # FAISS sauvegarde deux fichiers (index.faiss et index.pkl) dans ce dossier
    vector_store.save_local(PROCESSED_DATA_PATH)
    print(f"✅ Base de données vectorielle sauvegardée dans {PROCESSED_DATA_PATH}")

if __name__ == "__main__":
    build_vector_store()
