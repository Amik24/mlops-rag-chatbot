import os
import re
from pathlib import Path
from langchain_community.document_loaders import PyPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter

# Utiliser le même chemin que download_data.py
LOCAL_RAW_DATA_DIR = "data/raw" 

def clean_text(text):
    """Nettoyage de base du texte."""
    text = re.sub(r'PAGE \d+', '', text)
    text = re.sub(r'2025-26', '', text)
    text = re.sub(r'Sarah Malaeb', '', text)
    text = re.sub(r'\s+', ' ', text).strip()
    return text

def process_documents():
    """Charge les PDF, nettoie et divise en chunks."""
    documents = []
    
    pdf_files = list(Path(LOCAL_RAW_DATA_DIR).glob("*.pdf"))
    if not pdf_files:
        print(f"❌ Erreur : Aucun PDF trouvé dans {LOCAL_RAW_DATA_DIR}. Le téléchargement a-t-il réussi ?")
        return []

    for file_path in pdf_files:
        print(f"Processing: {file_path.name}...")
        loader = PyPDFLoader(str(file_path))
        docs = loader.load()
        
        for doc in docs:
            doc.page_content = clean_text(doc.page_content)
            doc.metadata["source_file"] = file_path.name
        
        documents.extend(docs)

    # Chunking
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=800,
        chunk_overlap=100
    )
    chunks = text_splitter.split_documents(documents)
    print(f"✅ Génération terminée : {len(chunks)} chunks.")
    return chunks

if __name__ == "__main__":
    process_documents()
